steps:
  - id: "Python unit test"
    name: "bash"
    script: |
      #!/usr/bin/env bash
      python -m pip install --upgrade pip
      python -m pip install -r requirements.txt
      cd workspace
      python -m unittest test/test_main.py

  - id: "Deploy"
    name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud config set project $PROJECT_ID
        cd ./src
        pip3 install -r requirements.txt
        gcloud functions deploy ${REPO_NAME} \
          --entry-point cloudbuild_notifications \
          --gen2 \
          --trigger-topic cloud-builds \
          --region europe-west1 \
          --serve-all-traffic-latest-revision \
          --runtime python312 \
          --retry \
          --set-secrets="SLACK_URL=slack-webhook-url:latest" \
          --timeout=540s \
          --memory=2048MB
    timeout: 1800s
